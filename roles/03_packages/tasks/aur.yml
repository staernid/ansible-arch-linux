---
- name: Install AUR helper (yay)
  when: >
    ('yay' not in ansible_facts.packages) and
    ('yay-bin' not in ansible_facts.packages) and
    ('yay-git' not in ansible_facts.packages)
  tags: yay
  block:
    - name: Install dependencies
      become: true
      community.general.pacman:
        name: "{{ item }}"
        state: present
      with_items:
        - base-devel
        - git
        - go

    - name: Create temporary directory for yay
      ansible.builtin.tempfile:
        state: directory
        suffix: _yay
      register: yay_tmp_dir
      become: false

    - name: Clone yay into temp dir
      ansible.builtin.git:
        repo: https://aur.archlinux.org/yay-git.git
        dest: "{{ yay_tmp_dir.path }}"
        version: master
        depth: 1
      become: false

    - name: Build AUR helper (yay)
      ansible.builtin.command: makepkg --noconfirm -sf
      become: false
      args:
        chdir: "{{ yay_tmp_dir.path }}"
      register: my_output
      when: not ansible_check_mode

    - name: Install the built package
      ansible.builtin.shell: |
        set -o pipefail
        pacman -U --noconfirm $(ls {{ yay_tmp_dir.path }}/yay-*.pkg.tar.zst | grep -v -- -debug)
      become: true
      when: not ansible_check_mode

- name: Create the `aur_builder` user
  become: yes
  ansible.builtin.user:
    name: aur_builder
    create_home: yes
    group: wheel

- name: Allow the `aur_builder` user to run `sudo pacman` without a password
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/11-install-aur_builder
    line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    create: yes
    mode: 0644
    validate: 'visudo -cf %s'

- name: Create flat list of packages
  ansible.builtin.set_fact:
    packages_to_install: >-
      {% for pkg in packages %}
        {{ pkg | quote }}
      {% endfor %}
  vars:
    packages: >-
      {{
        (official_packages.get('general', [])) +
        (official_packages.get('shell', [])) +
        (official_packages.get('archiving', [])) +
        (official_packages.get('development', []) if development else []) +
        (official_packages.get('media', []) if media else []) +
        (official_packages.get('gaming', []) if gaming else []) +
        (official_packages.get('printing_scanning', []) if printing_scanning else []) +
        (official_packages.get('fonts', []) if desktop else []) +
        (aur_packages.get('general', [])) +
        (aur_packages.get('printing_scanning', []) if printing_scanning else []) +
        (['lizardbyte/sunshine'] if sunshine | default(false) | bool else [])
      }}

- name: Install batch of packages
  become: true
  become_user: aur_builder
  retries: 5
  delay: 5
  ansible.builtin.command: >
    yay -S
      --answerclean none --answeredit none --answerupgrade none --answerdiff none
      --removemake --noconfirm --combinedupgrade --needed
      {{ packages_to_install }}

