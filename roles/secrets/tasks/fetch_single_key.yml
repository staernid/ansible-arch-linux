---
- name: Fetch Bitwarden item for {{ host_item }}
  delegate_to: localhost
  block:
    - name: Lookup Bitwarden item for host {{ host_item }}
      ansible.builtin.set_fact:
        secrets_bw_item_raw: "{{ lookup('community.general.bitwarden', ssh_key_prefix + host_item, session_key=bw_session) }}"
      no_log: true
      failed_when: false

    - name: Parse Bitwarden item for {{ host_item }}
      ansible.builtin.set_fact:
        secrets_current_bw_item: "{{ (secrets_bw_item_raw | from_json)[0] if (secrets_bw_item_raw is defined and secrets_bw_item_raw | length > 0) else {} }}"
      no_log: true

    - name: Extract Private Key for {{ host_item }}
      ansible.builtin.set_fact:
        secrets_private_key_content: >-
          {{
            (secrets_current_bw_item.fields | default([])) |
            selectattr('name', 'equalto', ssh_key_field) |
            map(attribute='value') |
            first |
            default(secrets_current_bw_item.notes | default(''))
          }}
      no_log: true

- name: Deploy SSH key for {{ host_item }}
  ansible.builtin.copy:
    content: "{{ secrets_private_key_content }}"
    dest: "{{ ssh_key_dir }}/{{ host_item }}"
    mode: '0600'
    owner: "{{ user.name }}"
    group: "{{ user.primary_group }}"
  become: true
  no_log: true
  when: secrets_private_key_content is defined and secrets_private_key_content | length > 0
