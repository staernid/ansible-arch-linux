---
- name: "Fetch Bitwarden item for {{ host_item }}"
  delegate_to: localhost
  block:
    - name: "Lookup Bitwarden item: {{ ssh_key_prefix }}{{ host_item }}"
      ansible.builtin.set_fact:
        bw_item_raw: "{{ lookup('community.general.bitwarden', ssh_key_prefix + host_item, session_key=bw_session) }}"
      no_log: true
      ignore_errors: true

    - name: "Parse Bitwarden item for {{ host_item }}"
      ansible.builtin.set_fact:
        current_bw_item: "{{ (bw_item_raw | from_json)[0] if (bw_item_raw is defined and bw_item_raw | length > 0) else {} }}"
      no_log: true

    - name: "Extract Private Key for {{ host_item }}"
      ansible.builtin.set_fact:
        private_key_content: >-
          {{ 
            (current_bw_item.fields | default([])) | 
            selectattr('name', 'equalto', ssh_key_field) | 
            map(attribute='value') | 
            first | 
            default(current_bw_item.notes | default('')) 
          }}
      no_log: true

- name: "Deploy SSH key for {{ host_item }}"
  ansible.builtin.copy:
    content: "{{ private_key_content }}"
    dest: "{{ ssh_key_dir }}/{{ host_item }}"
    mode: '0600'
    owner: "{{ user.name }}"
    group: "{{ user.primary_group }}"
  become: true
  no_log: true
  when: private_key_content is defined and private_key_content | length > 0
